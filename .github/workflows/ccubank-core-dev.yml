name: ccubank-core CI

on:
  push:
    branches: [main]

jobs:
#  lint:
#    runs-on: ubuntu-latest
#
#    steps:
#      - name: Checkout repository
#        uses: actions/checkout@v3
#
#      - name: Install node
#        uses: actions/setup-node@v3
#        with:
#          node-version:  "20.18.2"
#
#      - name: Install Dependencies
#        run: yarn install --frozen-lockfile
#
#      - name: Run Lint
#        run: yarn lint

  build:
    runs-on: ubuntu-latest
#    needs: lint
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Log in to Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build image
        run: |
          chmod +x scripts/create_env.sh ./scripts/create_env.sh
          docker build -t sjc.vultrcr.com/hangregistry469/ccubank-core:latest -f Dockerfile .

      - name: Push image to registry
        run: |
          echo ${{ secrets.REGISTRY_PASSWORD }} | docker login sjc.vultrcr.com -u ${{ secrets.REGISTRY_USERNAME }} --password-stdin
          docker push sjc.vultrcr.com/hangregistry469/ccubank-core:latest
          docker image prune -f
          docker logout ${{ secrets.REGISTRY }}

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Remote to server and deploy
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          WEB_SERVER_SSH_HOST: ${{ secrets.WEB_SERVER_SSH_HOST }}
          DEPLOY_SCRIPT_PATH: /scripts/deploy.sh
        run: |
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ./scripts/deploy.sh ${{ secrets.WEB_SERVER_SSH_HOST}}:/tmp/deploy.sh
          ssh $WEB_SERVER_SSH_HOST "bash -s" < $DEPLOY_SCRIPT_PATH

